# Analytics Service

## Описание

Этот сервис предназначен для получения, хранения и асинхронной обработки аналитических данных. Основной процесс работы сервиса выглядит следующим образом:

1. **Получение запроса**:
    - Сервис получает входящие запросы и сохраняет данные в таблицу `raw_analytics`.

2. **Диспетчеризация задач**:
    - Диспетчер (`dispatcher`) периодически обращается к базе данных, извлекает задачи из таблицы `raw_analytics`, где `processed = false`, и отправляет их в очередь задач для воркеров.

3. **Обработка задач воркерами**:
    - Воркеры получают задачи из очереди, обрабатывают их и сохраняют результаты в таблицу `analytics`.

## Структура таблиц

**raw_analytics**
```sql
create table if not exists analytics (
    id bigserial primary key,
    timestamptz(0) not null,
    user_id uuid not null,
    data jsonb not null
);
```

**analytics**
```sql
create table if not exists raw_analytics (
     id bigserial primary key,
     time timestamptz(0) not null,
    user_id uuid not null,
    data jsonb not null,
    processed boolean default false
);
```
**Поток работы**:
- Входящий запрос сохраняется в `raw_analytics`.
- Диспетчер выбирает задачи из `raw_analytics` и отправляет их в очередь задач для воркеров.
- Воркеры обрабатывают задачи и сохраняют результаты в `analytics`.

**Недоработки**:
- Логи и трассировка (trace) не настроены.
- Не решена проблема обработки ошибок. В текущей реализации, если метод ProcessTask в горутине вернул ошибку и мы не смогли обновить переменную processed на false в базе данных (UpdateProcessedData), эта работа будет висеть как processed = true, пока не будет вручную переведена обратно в false.

***Возможное решение проблемы обработки ошибок***
- Для решения проблемы, когда задача зависает в состоянии `processed = true` из-за ошибки обновления, можно добавить колонку `delay` в таблицу `raw_analytics`. Это позволит диспетчеру учитывать задержку и повторно обрабатывать задачи, если время `delay` истекло.

## Запуск проекта
```shell
docker-compose up --build
```

## Нагрузочное тестирование

Для оценки производительности нашего приложения был выполнен тест с использованием инструмента `wrk`. Ниже приведены результаты тестирования:

- **Среда тестирования**: MacBook Air (M3, 8GB RAM, 512GB SSD)
- **Команда для тестирования**: `wrk -t5 -c1000 -d30s -s post.lua http://localhost:8080/analytics`
    - **-t4**: 5 треда
    - **-c100**: 1000 одновременных соединений
    - **-d30s**: Длительность теста 30 секунд

```plaintext
Running 30s test @ http://localhost:8080/analytics
  5 threads and 1000 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    90.95ms   37.12ms 388.55ms   92.48%
    Req/Sec     2.28k   631.60     3.83k    72.51%
  337287 requests in 30.10s, 46.32MB read
  Socket errors: connect 0, read 3456, write 0, timeout 0
Requests/sec:  11206.18
Transfer/sec:      1.54MB
```

- **Requests/sec**: Общее количество запросов в секунду — 11206.18.

- **Transfer/sec**: Скорость передачи данных — 1.54MB/сек.

## Заключение
- Этот сервис обеспечивает асинхронную обработку задач, что повышает его производительность и отказоустойчивость. Однако для полного завершения проекта необходимо настроить логи и обработку ошибок, а также рассмотреть механизм обработки зависших задач.

